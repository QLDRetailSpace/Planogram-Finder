<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planogram Finder</title>

<style>
body { font-family: Arial; padding: 15px; background:#f4f6f8; }

select, input {
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
}

label {
  font-weight:bold;
  margin-top:10px;
  display:block;
}

.card {
  background:#fff;
  padding:14px;
  margin-top:10px;
  border-radius:10px;
  box-shadow:0 2px 5px rgba(0,0,0,0.08);
}

.card a {
  text-decoration:none;
  font-weight:bold;
  color:#0b57d0;
}
</style>
</head>

<body>

<h2>Planogram Finder</h2>

<label>Channel</label>
<select id="channel" onchange="updateGroups()"></select>

<label>Group</label>
<select id="group" onchange="updateCategories()"></select>

<label>Category</label>
<select id="category" onchange="showFiles()"></select>

<div id="results"></div>

<script>

// ================= CSV LINKS =================
const structureURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0R6jVdyfATmBNYLG2bcy4VF-DxWSLvrVFOe9qepHCCph6OCcIUGOwAkiNRn_TSGM-jr8VgjWC8-PU/pub?gid=1122095800&single=true&output=csv";
const fileURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRPSHnZioYj2Xdxx0CNi5VYlzlm0OL5aWAnr_eI9rSyboMnznDUyJzYt1DZ0Vret_CRqxO2aP8fDy9y/pub?gid=1791414175&single=true&output=csv";

let structureData = [];
let fileData = [];

// ================= CSV PARSER =================
function parseCSV(text){
  const rows = text.trim().split("\n");

  const headers = rows[0]
    .split(",")
    .map(h => h.replace(/^\uFEFF/, "").trim());

  return rows.slice(1).map(row => {
    const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);

    let obj = {};
    headers.forEach((h,i)=>{
      obj[h] = values ? values[i]?.replace(/"/g,"") : "";
    });

    return obj;
  });
}

// ================= LOAD DATA =================
Promise.all([
  fetch(structureURL).then(r => r.text()),
  fetch(fileURL).then(r => r.text())
]).then(([s1, s2]) => {

  const structureRaw = parseCSV(s1);
  const fileRaw = parseCSV(s2);

  structureData = structureRaw;
  fileData = fileRaw;

  initChannels();
});

// ================= CLEAN HELPERS =================
function clean(v){
  return (v || "")
    .toString()
    .toLowerCase()
    .replace(" channel","")   // ðŸ‘ˆ strip this out
    .trim();
}

// ================= CHANNEL DROPDOWN =================
function initChannels(){

  const keys = Object.keys(fileData[0]);
  const channelKey = keys.find(k => k.toLowerCase().includes("channel"));

  const channels = [...new Set(fileData.map(r => r[channelKey]))];

  channel.innerHTML = "<option value=''>Select Channel</option>";

  channels.forEach(c => {
    channel.innerHTML += `<option value="${c}">${c}</option>`;
  });
}

// ================= GROUP DROPDOWN =================
function updateGroups(){

  const keys = Object.keys(fileData[0]);
  const channelKey = keys.find(k => k.toLowerCase().includes("channel"));
  const groupKey   = keys.find(k => k.toLowerCase().includes("group"));

  const groups = [...new Set(
    fileData
      .filter(r => clean(r[channelKey]) === clean(channel.value))
      .map(r => r[groupKey])
  )];

  group.innerHTML = "<option value=''>Select Group</option>";

  groups.forEach(g=>{
    group.innerHTML += `<option value="${g}">${g}</option>`;
  });

  category.innerHTML = "";
  results.innerHTML = "";
}

// ================= CATEGORY DROPDOWN =================
function updateCategories(){

  const keys = Object.keys(fileData[0]);
  const channelKey  = keys.find(k => k.toLowerCase().includes("channel"));
  const groupKey    = keys.find(k => k.toLowerCase().includes("group"));
  const categoryKey = keys.find(k => k.toLowerCase().includes("category"));

  const categories = [...new Set(
    fileData
      .filter(r =>
        clean(r[channelKey]) === clean(channel.value) &&
        clean(r[groupKey]) === clean(group.value)
      )
      .map(r => r[categoryKey])
  )];

  category.innerHTML = "<option value=''>Select Category</option>";

  categories.forEach(c=>{
    category.innerHTML += `<option value="${c}">${c}</option>`;
  });

  results.innerHTML = "";
}

// ================= SHOW FILES =================
function showFiles(){

  if(fileData.length === 0) return;

  const keys = Object.keys(fileData[0]);

  const channelKey   = keys.find(k => k.toLowerCase().includes("channel"));
  const groupKey     = keys.find(k => k.toLowerCase().includes("group"));
  const categoryKey  = keys.find(k => k.toLowerCase().includes("category"));
  const linkKey      = keys.find(k => k.toLowerCase().includes("link"));
  const fileNameKey  = keys.find(k => k.toLowerCase().includes("file"));

  const matches = fileData.filter(r =>
    clean(r[channelKey]) === clean(channel.value) &&
    clean(r[groupKey]) === clean(group.value) &&
    clean(r[categoryKey]) === clean(category.value)
  );

  results.innerHTML = "";

  if(matches.length === 0){
    results.innerHTML = "<div class='card'>No files found</div>";
    return;
  }

  matches.forEach(r => {
    const displayName = r[fileNameKey] || r[categoryKey];

    results.innerHTML += `
      <div class="card">
        <a href="${r[linkKey]}" target="_blank">
          ðŸ“„ ${displayName}
        </a>
      </div>
    `;
  });
}

</script>

</body>
</html>

