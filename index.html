<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QLD Retail Space Planograms</title>

<style>
body { font-family: Arial; padding: 15px; background:#f4f6f8; }
select, input { width:100%; padding:12px; margin:6px 0; border-radius:8px; border:1px solid #ccc; }
label { font-weight:bold; margin-top:10px; display:block; }
.card { background:#fff; padding:14px; margin-top:10px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.08); }
.card a { text-decoration:none; font-weight:bold; color:#0b57d0; }
</style>
</head>

<body>

<h2>Planogram Finder</h2>

<label>Channel</label>
<select id="channel" onchange="updateGroups()"></select>

<label>Group</label>
<select id="group" onchange="updateCategories()"></select>

<label>Category</label>
<select id="category" onchange="showFiles()"></select>

<div id="results"></div>

<script>

// ================= CSV LINKS =================
const structureURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0R6jVdyfATmBNYLG2bcy4VF-DxWSLvrVFOe9qepHCCph6OCcIUGOwAkiNRn_TSGM-jr8VgjWC8-PU/pub?gid=1122095800&single=true&output=csv";
const fileURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRPSHnZioYj2Xdxx0CNi5VYlzlm0OL5aWAnr_eI9rSyboMnznDUyJzYt1DZ0Vret_CRqxO2aP8fDy9y/pub?gid=1791414175&single=true&output=csv";

let structureData = [];
let fileData = [];

// ================= CSV PARSER =================
function parseCSV(text){
  const rows = text.trim().split("\n");
  const headers = rows[0].split(",").map(h => h.replace(/^\uFEFF/, "").trim());

  return rows.slice(1).map(r=>{
    const values = r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    let obj={};
    headers.forEach((h,i)=> obj[h]=values[i]?.replace(/"/g,""));
    return obj;
  });
}

// ================= LOAD DATA =================
Promise.all([
  fetch(structureURL).then(r=>r.text()),
  fetch(fileURL).then(r=>r.text())
]).then(([s1,s2])=>{

  const structureRaw = parseCSV(s1);
  const fileRaw = parseCSV(s2);

  // build structure from folder paths
  structureData = structureRaw.map(row=>{
    const key = Object.keys(row).find(k=>k.toLowerCase().includes("path"));
    const parts = row[key].split("/").map(p=>p.trim());
    return {
      Channel: parts[0].replace(" Channel","").toUpperCase(),
      Category: parts[parts.length-1]
    };
  });

  fileData = fileRaw;

  initChannels();
});

// ================= CLEANERS =================
function clean(v){ return (v||"").toString().toLowerCase().trim(); }

// ================= CHANNEL =================
function initChannels(){
  const channels = [...new Set(structureData.map(x=>x.Channel))];
  channel.innerHTML = "<option value=''>Select Channel</option>";
  channels.forEach(c=> channel.innerHTML += `<option value="${c}">${c}</option>`);
}

// ================= GROUP =================
function updateGroups(){

  const groups = [...new Set(
    fileData
      .filter(f => clean(f.Channel) === clean(channel.value))
      .map(f => f.Group)
  )];

  group.innerHTML = "<option value=''>Select Group</option>";
  groups.forEach(g=> group.innerHTML += `<option value="${g}">${g}</option>`);

  category.innerHTML = "";
  results.innerHTML = "";
}

// ================= CATEGORY =================
function updateCategories(){

  const cats = [...new Set(
    fileData
      .filter(f =>
        clean(f.Channel) === clean(channel.value) &&
        clean(f.Group) === clean(group.value)
      )
      .map(f => f.Category)
  )];

  category.innerHTML = "<option value=''>Select Category</option>";
  cats.forEach(c=> category.innerHTML += `<option value="${c}">${c}</option>`);

  results.innerHTML = "";
}

// ================= SHOW FILES =================
function showFiles(){

  if(fileData.length === 0) return;

  // ðŸ” detect column names dynamically
  const keys = Object.keys(fileData[0]);

  const channelKey   = keys.find(k => k.toLowerCase().includes("channel"));
  const groupKey     = keys.find(k => k.toLowerCase().includes("group"));
  const categoryKey  = keys.find(k => k.toLowerCase().includes("category"));
  const linkKey      = keys.find(k => k.toLowerCase().includes("link"));
  const fileNameKey  = keys.find(k => k.toLowerCase().includes("file"));

  console.log("Detected keys:", {
    channelKey, groupKey, categoryKey, linkKey, fileNameKey
  });

  const selectedChannel  = clean(channel.value);
  const selectedGroup    = clean(group.value);
  const selectedCategory = clean(category.value);

  const matches = fileData.filter(f =>
    clean(f[channelKey])  === selectedChannel &&
    clean(f[groupKey])    === selectedGroup &&
    clean(f[categoryKey]) === selectedCategory
  );

  results.innerHTML = "";

  if(matches.length === 0){
    results.innerHTML = "<div class='card'>No files found</div>";
    return;
  }

  matches.forEach(r=>{
    const displayName = r[fileNameKey] || r[categoryKey];

    results.innerHTML += `
      <div class="card">
        <a href="${r[linkKey]}" target="_blank">
          ðŸ“„ ${displayName}
        </a>
      </div>
    `;
  });
}

</script>

</body>
</html>



